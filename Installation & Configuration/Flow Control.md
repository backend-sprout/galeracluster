# Flow Control(흐름제어)   
   
Galera Cluster는 Flow Control이라는 피드백 메커니즘을 사용하여 복제 프로세스를 관리한다.       
Flow Control은 **트랜잭션을 적용할 때 노드가 다른 노드보다 너무 뒤쳐지는 것을 방지하는 것으로**     
Flow Control를 사용하면 노드가 필요에 따라 **복제를 일시 중지하고 재개할 수 있다.**          

## 흐름 제어 작동 방식
   
Galera Cluster는 클러스터의 모든 노드에 순서대로 트랜잭션이 복사됨으로써 동기식 복제를 달성한다.          
즉, **트랜잭션이 클러스터를 통해 복제될 때 트랜잭션이 적용되고 커밋이 비동기적으로 발생한다.**     
          
노드는 쓰기 데이터를 수신하고 이를 전역 순서로 구성한다.     
노드가 클러스터에서 수신하지만 적용 및 커밋되지 않은 트랜잭션은 수신 대기큐에 보관된다.  
      
수신된 큐가 특정 크기에 도달하면 노드가 흐름 제어를 트리거한다.          
노드는 복제를 일시 중지한 다음 수신된 대기열을 통해 작업한다.      
수신된 큐를 보다 관리하기 쉬운 크기로 줄이면 노드가 복제를 재개한다.     
  
## 노드 상태 이해  
        
Galera Cluster는 노드 상태에 따라 여러 형태의 Flow Control을 구현한다.         
Flow Control 구현체는 가상 동기화가 제공하는 논리적인 것과는 대조적으로 시간적 동기화와 일관성을 보장한다.      
         
**Flow Control 에는 기본적으로 네 가지 종류가 있다.**       
* 흐름 제어 없음
* 쓰기 세트 캐싱
* 따라잡기
* 클러스터 동기화

## No Flow Control
       
No Flow Control은 노드가 OPEN 또는 PRIMARY 상태일 때 적용된다.           
즉, 노드가 OPEN 또는 PRIMARY 상태인 경우 유지하면 클러스터의 일부로 간주되지 않는다.         
이러한 노드는 쓰기 세트를 복제, 적용 또는 캐시할 수 없다.      

## Write-Set Caching  
           
Write-Set Caching는 노드가 JOINER 및 DONOR 상태일 때 적용된다.        
노드는 이 상태에 있는 동안 **쓰기 세트를 적용할 수 없으며 나중을 위해 캐시해야 한다.**               
모든 복제를 중지하는 것 외에는 노드를 클러스터와 동기화된 상태로 유지하는 합리적인 방법이 없다.      
     
쓰기 세트 캐시가 구성된 크기를 초과하지 않도록 **복제 속도를 제한할 수 있다.**      
다음 매개변수를 사용하여 쓰기 세트 캐시를 제어할 수 있다.     
  
* gcs.recv_q_hard_limit : 최대 쓰기 세트 캐시 크기(바이트).
* gcs.max_throttle : 노드가 클러스터에서 허용할 수 있는 일반 복제 속도에 대한 가장 작은 부분이다.
* gcs.recv_q_soft_limit : 노드의 평균 복제 속도 추정치.

